<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css"
        integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
    <script src="../sweetalert/sweetalert.js"></script>
    <script src="../telaInicial/dialogos.js"></script>
    <link rel="stylesheet" href="../css/repeticao.css">


    <title>Document</title>
</head>

<body>
    <audio id="audio" src="../sounds/repeticao.mp3" loop autoplay></audio>



    <div class="repeticao">


        <img class="estrela" src="../img/repeticao/estrela.png">
        <img class="estrela2" src="../img/repeticao/estrela.png">


        <img class="nuvens" src="../img/decisao/clouds.png">
        <img class="nuvens2" src="../img/decisao/clouds.png">
        <img class="nuvens3" src="../img/decisao/clouds.png">


        <img class="arvore" src="../img/repeticao/arvore.png" style.right="-220px">

        <img class="ajudante" id="ajudante" src="../img/repeticao/timburr.png">

        <div>

            <img class="pikachu" id="pikachu" src="../img/repeticao/pikachu.gif">
            <img style="display: none;" class="viga" id="viga" src="../img/repeticao/raio.gif">

            <div class="infoViga" id="infoViga" style="display: none;">
                <h5 class="textoViga"> Os peixes voadores não conseguem perfurar suas
                    faiscas,
                    use-as com espaço para se proteger.</h5>>
                <img class="exclamacaoAzul" id="exclamacaoAzul" src="../img/repeticao/exclamacaoAzul.png">
            </div>
        </div>


        <div class="peixes">
            <img class="goldeen" id="goldeen" src="../img/repeticao/goldeen.png">
            <img class="seaking" id="seaking" src="../img/repeticao/seaking.png">
            <img class="qwilfish" id="qwilfish" src="../img/repeticao/qwilfish.png">
            <img class="basculin" id="basculin" src="../img/repeticao/basculin.png">
        </div>



        <div class="textoVidaExtra" style="display: none;">
            <h5>Uma forte ventania arrastou um Drifloon até aqui, pegue-o para ganhar
                uma vida</h5>
            <img class="exclamacao" src="../img/repeticao/exclamacao.png"></img>
        </div>
        <div class="vidaExtra" style="display: none;">
            <img id="vidaExtra" src="../img/repeticao/vida.png"></img>
            <img class="drifloon" id="drifloon" src="../img/repeticao/drifloon.png">
        </div>

        <div class="mantineMantyke" style="display: none;">
            <img class="mantine" id="mantine" src="../img/repeticao/mantine.png">
            <img class="mantyke1" id="mantyke1" src="../img/repeticao/mantyke.png">
            <img class="mantyke2" id="mantyke2" src="../img/repeticao/mantyke.png">
        </div>

        <div class="tentaLlery" style="display: none;">
            <img class="tentacruel" id="tentacruel" src="../img/repeticao/tentacruel.png">
            <img class="octillery" id="octillery" src="../img/repeticao/octillery.png">
        </div>
        <img style="display: none;" class="sinalizacao" id="sinalizacao" src="../img/repeticao/exclamacao.png">




        <div class="obstaculo">
            <div class="rio"></div>
            <img class="entrada" id="entrada" src="../img/repeticao/obstaculo.png">
            <img class="saida" id="saida" src="../img/repeticao/obstaculo.png">

        </div>



        <div>
            <img style="display: none;" class="starmie" src="../img/repeticao/starmie.png">

        </div>

        <img style="display: none;" class="bolhas" src="../img/repeticao/agua.png">


        <img class="tronco_queda" id="tronco_queda" src="../img/repeticao/tronco_queda.png">



        <div class="tronco"></div>



        <div class="ponte">
            <div class="filhoPonte" id="id16"></div>

            <div class="filhoPonte" id="id15"></div>
            <div class="filhoPonte" id="id14"></div>
            <div class="filhoPonte" id="id13"></div>
            <div class="filhoPonte" id="id12"></div>
            <div class="filhoPonte" id="id11"></div>
            <div class="filhoPonte" id="id10"></div>

            <div class="filhoPonte" id="id9"></div>
            <div class="filhoPonte" id="id8"></div>
            <div class="filhoPonte" id="id7"></div>
            <div class="filhoPonte" id="id6"></div>
            <div class="filhoPonte" id="id5"></div>
            <div class="filhoPonte" id="id4"></div>
            <div class="filhoPonte" id="id3"></div>
            <div class="filhoPonte" id="id2"></div>
            <div class="filhoPonte" id="id1"></div>
            <div class="filhoPonte" id="id0"></div>

        </div>



        <div class="vidas">
            <div class="vidas1">
                <img src="../img/repeticao/vida.png"></img>
            </div>
            <div class="vidas2">
                <img src="../img/repeticao/vida.png"></img>
            </div>
            <div class="vidas3">
                <img src="../img/repeticao/vida.png"></img>
            </div>
        </div>


        <div class="indicador">
            <img id="imgIndicador" src="../img/repeticao/tronco_queda.png" style="display:none"></img>
            <img id="xIndicador" src="../img/repeticao/x.png" style="display:block"></img>
        </div>


    </div>






    <script>

        var elementoPonte = document.getElementById("id" + 4);
        var loc = elementoPonte.getBoundingClientRect();
        var localizacao = loc.left + window.pageXOffset;

        var entradaP = document.getElementById("entrada");                //pega localizacao da madeira da entrada da ponte 
        var localizacaoEntradaP = entradaP.getBoundingClientRect();
        var locEntrada = localizacaoEntradaP.left + window.pageXOffset;

        var popUp = "false";    //definicao das variaveis que seram utilizadas no codigo
        var viga = "desativada";
        let tronco = 0;
        vidas = 3
        var textoVida = 0;
        var verificaPopUp = "false";

        var troncos = document.querySelector('.troncos');
        var pikachu = document.querySelector('.pikachu');
        var starmie = document.querySelector('.starmie');
        var bolhas = document.querySelector('.bolhas');
        var entrada = document.querySelector('.entrada');

        starmieRemove = true;
        entrada.getBoundingClientRect();

        const alteraVida = () => {      //realiza a alteracao na vida do jogador, caso ele sofra um ataque

            if (vidas == 3) {
                document.querySelector(".vidas3").remove();
                vidas = vidas - 1;
            } else if (vidas == 2) {
                document.querySelector(".vidas2").remove();
                vidas = vidas - 1;
            } else if (vidas == 1) {
                document.querySelector(".vidas1").remove();
                vidas = vidas - 1;
            } else if (vidas == 0) {
                document.querySelector(".pikachu").remove();
                if (popUp == "false") {
                    exibeNotificação("error", "Você perdeu todas as vidas! Clique para tentar novamente", './repeticao.html');
                    popUp = "true";
                }
            }
        }


        for (var j = 0; j < 5; j++) {       //gera cinco troncos iniciais para compor a ponte
            document.getElementById("id" + tronco).innerHTML = "<img src='../img/repeticao/tronco_ponte.png'>";
            tronco = tronco + 1;
        }


        const loop = setInterval(() => {    //loop necessario para fazer verificacoes relevantes, como colisoes ...
            if (tronco == 17 && vidas >= 0) {
                if (verificaPopUp == "false") {
                    document.querySelector(".ajudante").style.animationPlayState = "running";

                    exibeNotificação("success", "Você concluiu a fase! Vamos as perguntas da fase!", '../Quizes/quizEntreFases.html?fase=3');
                    verificaPopUp = "true";
                }
            }

            //defini qual inimigo aparecera em determinado momento da fase

            if (tronco == 6) {
                document.querySelector(".starmie").style.display = "block";
                document.querySelector(".basculin").style.animationPlayState = "running";
            } if (tronco == 7) {
                document.querySelector(".goldeen").style.animationPlayState = "running";
            }
            if (tronco == 9) {
                document.querySelector(".qwilfish").style.animationPlayState = "running";
                document.querySelector(".seaking").style.animationPlayState = "running";
            }
            if (tronco == 10) {
                document.querySelector(".mantineMantyke").style.display = "block";
                document.querySelector(".infoViga").style.display = "block";

                if(starmieRemove == true){
                    document.querySelector(".starmie").remove();
                    starmieRemove = false;
                }
                //document.querySelector(".starmie").style.display = "none";
            }
            if (tronco == 11) {
                document.querySelector(".infoViga").style.display = "none";
            }
            if (tronco == 14) {
                document.querySelector(".goldeen").style.display = "none";
                document.querySelector(".qwilfish").style.display = "none";
                document.querySelector(".basculin").style.display = "none";
                document.querySelector(".seaking").style.display = "none";
                document.querySelector(".mantineMantyke").style.display = "none";
                document.querySelector(".tentaLlery").style.display = "block";
                document.querySelector(".sinalizacao").style.display = "block";
            }
            if (tronco == 15) {
                document.querySelector(".sinalizacao").style.display = "none";
            }

            if (vidas <= 2) {
                if (textoVida == 0) {
                    document.querySelector(".textoVidaExtra").style.display = "block";
                    textoVida = textoVida + 1;
                }
                document.querySelector(".vidaExtra").style.display = "block";
            }

            pikachu.getBoundingClientRect();
            starmie.getBoundingClientRect();
            mantykes = document.querySelectorAll("div.mantineMantyke #mantyke1, div.mantineMantyke #mantyke2");
            tentaLlery = document.querySelectorAll("div.tentaLlery #octillery, div.tentaLlery #tentacruel");
            drifloon = document.getElementById("drifloon");
            troncos_queda = document.getElementById("tronco_queda");

            //funcoes e lacos de repeticao para capturar colisoes entre personagem e inimigo

            for (var i = 0; i < tentaLlery.length; i++) {

                if ((pikachu.x + 30 < tentaLlery[i].x + tentaLlery[i].width && pikachu.x - 30 + pikachu.width > tentaLlery[i].x) && (pikachu.y + 30 < tentaLlery[i].y + tentaLlery[i].height && pikachu.y - 30 + pikachu.height > tentaLlery[i].y)) {
                    document.querySelector("#octillery").style.animation = 'none';
                    document.querySelector("#tentacruel").style.animation = 'none';
                    personagem.style.setProperty('--left-start-pikachu', '0%');
                    //personagem.style.left = "0%";
                    setInterval(function () {
                        document.querySelector("#octillery").style.animation = "";
                        document.querySelector("#tentacruel").style.animation = "";
                    }, 10);
                    alteraVida();
                }
            }

            if ((pikachu.x + 30 < troncos_queda.x + troncos_queda.width && pikachu.x - 30 + pikachu.width > troncos_queda.x) && (pikachu.y + 30 < troncos_queda.y + troncos_queda.height && pikachu.y - 30 + pikachu.height > troncos_queda.y)) {
                troncos_queda.style.animation = 'none';

                setInterval(function () {
                    troncos_queda.style.animation = "";
                }, 10);
                document.getElementById("imgIndicador").style.display = "block";
                document.getElementById("xIndicador").style.display = "none";
            }

            if ((pikachu.x + 30 < drifloon.x + drifloon.width && pikachu.x - 30 + pikachu.width > drifloon.x) && (pikachu.y + 30 < drifloon.y + drifloon.height && pikachu.y - 30 + pikachu.height > drifloon.y)) {

                document.querySelector(".vidaExtra").style.display = "none";
                document.querySelector(".textoVidaExtra").style.display = "none";

                if (vidas < 3) {
                    var img = document.createElement('img');
                    img.src = '../img/repeticao/vida.png';
                    img.classList.add('vidas' + (vidas + 1));
                    img.style.width = "1.5%";
                    var pai = document.querySelector(".vidas");
                    pai.appendChild(img);
                    vidas = vidas + 1;
                }
            }

            for (var i = 0; i < mantykes.length; i++) {

                if ((pikachu.x + 30 < mantykes[i].x + mantykes[i].width && pikachu.x - 30 + pikachu.width > mantykes[i].x) && (pikachu.y + 30 < mantykes[i].y + mantykes[i].height && pikachu.y - 30 + pikachu.height > mantykes[i].y) && (viga != "ativada")) {

                    document.querySelector(".mantyke1").style.animation = 'none';
                    document.querySelector(".mantyke2").style.animation = 'none';
                    setInterval(function () {
                        document.querySelector("#mantyke1").style.animation = "";
                        document.querySelector("#mantyke2").style.animation = "";
                    }, 10);
                    alteraVida();

                } else if ((pikachu.x + 30 < mantykes[i].x + mantykes[i].width && pikachu.x - 30 + pikachu.width > mantykes[i].x) && (pikachu.y + 30 < mantykes[i].y + mantykes[i].height && pikachu.y - 30 + pikachu.height > mantykes[i].y) && (viga == "ativada")) {
                    document.querySelector(".mantyke1").style.animation = 'none';
                    document.querySelector(".mantyke2").style.animation = 'none';
                    setInterval(function () {
                        document.querySelector("#mantyke1").style.animation = "";
                        document.querySelector("#mantyke2").style.animation = "";
                    }, 10);
                }
            }

            peixes = document.querySelectorAll("div.peixes #goldeen, div.peixes #seaking, div.peixes #basculin, div.peixes #qwilfish");

            for (var i = 0; i < peixes.length; i++) {

                if ((pikachu.x + 30 < peixes[i].x + peixes[i].width && pikachu.x - 30 + pikachu.width > peixes[i].x) && (pikachu.y + 30 < peixes[i].y + peixes[i].height && pikachu.y - 30 + pikachu.height > peixes[i].y)) {
                    document.getElementById("xIndicador").style.display = "block";
                    document.getElementById("imgIndicador").style.display = "none";
                    personagem.style.setProperty('--left-start-pikachu', '0%');
                    //personagem.style.left = "0%";
                }
            }

            if ((pikachu.x + 40 < starmie.x + starmie.width && pikachu.x - 40 + pikachu.width > starmie.x) && (pikachu.y + 40 < starmie.y + starmie.height && pikachu.y - 40 + pikachu.height > starmie.y)) {
                personagem.style.setProperty('--left-start-pikachu', '0%');
                //personagem.style.left = "0%";
                document.querySelector(".starmie").style.display = 'none';
                document.querySelector(".starmie").style.animation = 'none';

                setInterval(function () {
                    document.querySelector(".starmie").style.display = 'block';
                    document.querySelector(".starmie").style.animation = "";
                }, 80);
                alteraVida();
            }
        }, 5);

        function removerMovimentoD() {
            personagem.classList.remove(movimentoD);
        }
        function removerMovimentoE() {
            personagem.classList.remove(movimentoE);
        }

        const animacaoPuloON = () => {
            const computedStyle = window.getComputedStyle(personagem);
            const animationName = computedStyle.animationName;
            const jumpAnimationName = 'inicial_movimento'; // Nome da animação de pulo específica
            return animationName === jumpAnimationName && computedStyle.animationPlayState === 'running';
        };


        //funcoes para mover o personagem na posicao desejada
        const moverDireita = () => {

            if (! animacaoPuloON()) {
                if (((pikachu.offsetLeft + 30) < localizacao)) {
                    document.getElementById("pikachu").style.transform = "scaleX(1)";
                    personagem.classList.remove('movimentoE'); // Remover a classe movimentoD
                    personagem.style.setProperty('--left-start-pikachu', getComputedStyle(personagem).left);
                    personagem.classList.add('movimentoD');
                    personagem.addEventListener('transitionend', removerMovimentoD);

                } else if (document.getElementById("imgIndicador").style.display == "block") {
                    document.getElementById("id" + tronco).innerHTML = "<img src='../img/repeticao/tronco_ponte.png'>";

                    elementoPonte = document.getElementById("id" + tronco);
                    loc = elementoPonte.getBoundingClientRect();
                    localizacao = loc.left + window.pageXOffset;
                    tronco = tronco + 1;
                    document.getElementById("imgIndicador").style.display = "none";
                    document.getElementById("xIndicador").style.display = "block";
                }
            }
        }

        const moverEsquerda = () => {

        if (! animacaoPuloON()) {
            if (((pikachu.offsetLeft + 30) > locEntrada)) {
                document.getElementById("pikachu").style.transform = "scaleX(-1)";
                personagem.classList.remove('movimentoD'); // Remover a classe movimentoD
                personagem.style.setProperty('--left-start-pikachu', getComputedStyle(personagem).left);
                personagem.classList.add('movimentoE');
                personagem.addEventListener('transitionend', removerMovimentoE);

            }
        }
        }

        const personagem = document.querySelector('.pikachu');

        const mover = () => {
            var tecla = event.keyCode;
            if (tecla == 39 && viga == "desativada") {
                moverDireita();
            } else if (tecla == 37 && viga == "desativada") {
                moverEsquerda();
            } else if (tecla == 32) {
                document.getElementById("viga").style.display = "block";
                document.getElementById("viga").style.left = (pikachu.offsetLeft) + "px";
                viga = "ativada";
            } else if(tecla == 38 && viga == "desativada"){
                personagem.classList.remove('movimentoD'); // Remover a classe movimentoD
                personagem.classList.remove('movimentoE'); // Remover a classe movimentoE

                personagem.classList.add('movimento');
                setTimeout(function () {
                    personagem.classList.remove('movimento');
                }, 1000);
            }
        }
        document.addEventListener('keydown', mover); //funcao para detectar pressionar de teclas, movimentacao

        document.addEventListener("keyup", function (event) {
            if (event.key == " ") {
                document.getElementById("viga").style.display = "none";
                viga = "desativada";
            }
        });

        const voltar_menu = () => {  //tecla de atalho para retornar ao menu
            var tecla = event.keyCode;

            if (tecla == 27) {
                window.location.href = '../telaInicial/city.html';
            }
        }
        document.addEventListener('keydown', voltar_menu);

    </script>


</body>

</html>